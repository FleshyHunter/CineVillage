
<%- include('../layouts/header') %>

<div class="container">
    <h2 style="margin-bottom: 30px;"><%= hall.name %> - Schedule</h2>

    <div class="movie-detail-container">
        <!-- Left Side: Hall Image -->
        <div class="movie-detail-poster">
            <img src="<%= hall.pictureUrl || '/images/placeholder.jpg' %>"
                alt="<%= hall.name %>"
                style="width: 100%; border-radius: 8px; object-fit: cover; min-height: 400px;">
            <div style="text-align: center; margin-top: 15px;">
                <h4 style="color: var(--text-main);"><%= hall.name %></h4>
                <p style="color: var(--text-muted); font-size: 13px;"><%= hall.type %> | <%= hall.capacity %> seats</p>
            </div>
        </div>

        <!-- Right Side: Calendar and Timeline -->
        <div class="movie-detail-info">
            
            <!-- Date Selection -->
            <div class="form-group">
                <label for="dateInput" style="color: var(--text-muted); font-size: 11px; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px; display: block;">SELECT DATE</label>
                <input type="date" id="dateInput" class="form-control" 
                       value="<%= new Date().toISOString().split('T')[0] %>"
                       min="<%= new Date().toISOString().split('T')[0] %>"
                       max="<%= new Date(new Date().setMonth(new Date().getMonth() + 3)).toISOString().split('T')[0] %>">
            </div>

            <!-- Hall Schedule Timeline -->
            <div id="timelineContainer" style="margin-bottom: 24px;">
                <label style="color: var(--text-muted); font-size: 11px; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 12px; display: block;">HALL SCHEDULE</label>
                <div style="background-color: var(--bg-card); padding: 16px; border-radius: 8px; border: 2px solid #334155;">
                    
                    <!-- Legend -->
                    <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 11px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 3px;"></div>
                            <span style="color: var(--text-muted);">Occupied</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 3px;"></div>
                            <span style="color: var(--text-muted);">Available</span>
                        </div>
                    </div>

                    <!-- Timeline: First 12 hours (00:00 - 11:45) -->
                    <div style="margin-bottom: 16px;">
                        <div id="dateLabel1" style="color: var(--text-main); font-size: 11px; margin-bottom: 4px; font-weight: 700;"></div>
                        <div style="color: var(--text-muted); font-size: 10px; margin-bottom: 4px; font-weight: 600;">00:00 - 11:45</div>
                        <div id="timeline-row1" style="display: grid; grid-template-columns: repeat(48, 1fr); gap: 2px;">
                            <!-- Slots generated by JavaScript -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="color: var(--text-muted); font-size: 9px;">00:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">03:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">06:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">09:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">11:45</span>
                        </div>
                    </div>

                    <!-- Timeline: Second 12 hours (12:00 - 23:45) -->
                    <div style="margin-bottom: 16px;">
                        <div style="color: var(--text-muted); font-size: 10px; margin-bottom: 4px; font-weight: 600;">12:00 - 23:45</div>
                        <div id="timeline-row2" style="display: grid; grid-template-columns: repeat(48, 1fr); gap: 2px;">
                            <!-- Slots generated by JavaScript -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="color: var(--text-muted); font-size: 9px;">12:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">15:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">18:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">21:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">23:45</span>
                        </div>
                    </div>

                    <!-- Timeline: Next day morning (00:00 - 11:45) -->
                    <div>
                        <div id="dateLabel2" style="color: var(--text-main); font-size: 11px; margin-bottom: 4px; font-weight: 700;"></div>
                        <div style="color: var(--text-muted); font-size: 10px; margin-bottom: 4px; font-weight: 600;">00:00 - 11:45</div>
                        <div id="timeline-row3" style="display: grid; grid-template-columns: repeat(48, 1fr); gap: 2px;">
                            <!-- Slots generated by JavaScript -->
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="color: var(--text-muted); font-size: 9px;">00:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">03:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">06:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">09:00</span>
                            <span style="color: var(--text-muted); font-size: 9px;">11:45</span>
                        </div>
                    </div>

                    <div id="timelineMessage" style="margin-top: 12px; color: var(--text-muted); font-size: 12px; text-align: center;">
                        Loading schedule...
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div class="movie-detail-actions">
                <a href="/screenings/by-hall" class="btn btn-secondary">
                    ‚Üê Back to Hall List
                </a>
            </div>

        </div>
    </div>
</div>

<script>
    const dateInput = document.getElementById('dateInput');
    const timelineRow1 = document.getElementById('timeline-row1');
    const timelineRow2 = document.getElementById('timeline-row2');
    const timelineRow3 = document.getElementById('timeline-row3');
    const timelineMessage = document.getElementById('timelineMessage');
    const dateLabel1 = document.getElementById('dateLabel1');
    const dateLabel2 = document.getElementById('dateLabel2');
    const hallId = '<%= hall._id %>';
    
    let currentSchedule = [];

    // Generate timeline slots
    function generateTimelineSlots() {
        timelineRow1.innerHTML = '';
        timelineRow2.innerHTML = '';
        timelineRow3.innerHTML = '';
        
        for (let i = 0; i < 48; i++) {
            // Row 1: Slots 0-47
            const slot1 = document.createElement('div');
            slot1.className = 'timeline-slot';
            slot1.dataset.slot = i;
            slot1.style.height = '20px';
            slot1.style.background = '#22c55e';
            slot1.style.borderRadius = '2px';
            slot1.style.cursor = 'pointer';
            slot1.title = formatSlotTime(i);
            timelineRow1.appendChild(slot1);
            
            // Row 2: Slots 48-95
            const slot2 = document.createElement('div');
            slot2.className = 'timeline-slot';
            slot2.dataset.slot = i + 48;
            slot2.style.height = '20px';
            slot2.style.background = '#22c55e';
            slot2.style.borderRadius = '2px';
            slot2.style.cursor = 'pointer';
            slot2.title = formatSlotTime(i + 48);
            timelineRow2.appendChild(slot2);
            
            // Row 3: Slots 96-143
            const slot3 = document.createElement('div');
            slot3.className = 'timeline-slot';
            slot3.dataset.slot = i + 96;
            slot3.style.height = '20px';
            slot3.style.background = '#22c55e';
            slot3.style.borderRadius = '2px';
            slot3.style.cursor = 'pointer';
            slot3.title = formatSlotTime(i);
            timelineRow3.appendChild(slot3);
        }
    }

    // Format slot number to time string
    function formatSlotTime(slot) {
        const adjustedSlot = slot % 96;
        const totalMinutes = adjustedSlot * 15;
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }
    
    // Update date labels
    function updateDateLabels() {
        const selectedDate = new Date(dateInput.value + 'T00:00:00');
        const nextDate = new Date(selectedDate);
        nextDate.setDate(nextDate.getDate() + 1);
        
        const formatDate = (date) => {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        };
        
        dateLabel1.textContent = formatDate(selectedDate);
        dateLabel2.textContent = formatDate(nextDate);
    }

    // Load hall schedule
    async function loadHallSchedule() {
        const date = dateInput.value;
        
        if (!date) {
            return;
        }
        
        try {
            timelineMessage.textContent = 'Loading schedule...';
            
            const response = await fetch(`/screenings/api/schedule/${hallId}/${date}`);
            if (!response.ok) {
                throw new Error('Failed to fetch schedule');
            }
            
            currentSchedule = await response.json();
            
            // Generate fresh slots
            generateTimelineSlots();
            
            // Mark occupied slots
            currentSchedule.forEach(block => {
                for (let slot = block.startSlot; slot < block.endSlot; slot++) {
                    const slotElement = document.querySelector(`.timeline-slot[data-slot="${slot}"]`);
                    if (slotElement) {
                        slotElement.style.background = '';
                        slotElement.style.backgroundColor = '#ef4444';
                        slotElement.title = `${block.movieName} (${block.displayStart} - ${block.displayEnd})`;
                    }
                }
            });
            
            if (currentSchedule.length > 0) {
                timelineMessage.textContent = `${currentSchedule.length} screening(s) scheduled`;
            } else {
                timelineMessage.textContent = 'No screenings scheduled for this date';
            }
        } catch (error) {
            console.error('Error loading schedule:', error);
            timelineMessage.textContent = 'Error loading schedule';
        }
    }

    // Date selection
    dateInput.addEventListener('change', function() {
        updateDateLabels();
        loadHallSchedule();
    });

    // Initialize on page load
    updateDateLabels();
    loadHallSchedule();
</script>

<%- include('../layouts/footer') %>
