<%- include('../layouts/header') %>

    <div class="container">
        <h2 class="page-title">Movies</h2>
        
        <!-- Filter Buttons -->
        <div class="movie-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="New">New</button>
            <button class="filter-btn" data-filter="Now Showing">Now Showing</button>
            <button class="filter-btn" data-filter="Coming Soon">Coming Soon</button>
            <button class="filter-btn" data-filter="Discontinued">Discontinued</button>
        </div>

        <!-- Search and Filter Controls -->
        <div class="search-filter-bar">
            <div class="search-controls">
                <!-- Search Bar -->
                <div class="search-box">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    <input 
                        type="text" 
                        id="movieSearch" 
                        class="search-input" 
                        placeholder="Search movies..."
                    >
                </div>

                <!-- Hall Filter -->
                <div class="filter-dropdown">
                    <select id="hallFilter" class="filter-select">
                        <option value="all">All Halls</option>
                        <% if (typeof halls !== 'undefined' && halls.length > 0) { %>
                            <% halls.forEach(hall => { %>
                                <option value="<%= hall.name %>"><%= hall.name %></option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>

                <!-- Date Filter -->
                <div class="filter-dropdown">
                    <input 
                        type="date" 
                        id="dateFilter" 
                        class="filter-select date-input"
                    >
                </div>

                <!-- Sort By -->
                <div class="filter-dropdown">
                    <select id="sortFilter" class="filter-select">
                        <option value="none">Sort By</option>
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="nameAZ">Name (A-Z)</option>
                        <option value="nameZA">Name (Z-A)</option>
                    </select>
                </div>
            </div>

            <!-- Create Button -->
            <div class="create-button-wrapper">
                <a href="/movies/create" class="btn btn-primary">
                    + Create New Movie
                </a>
            </div>
        </div>
        <div class="movies-grid">
            <% movies.forEach(movie=> { %>
                <a href="/movies/<%= movie._id %>" 
                   class="movie-card-link" 
                   data-status="<%= movie.status || 'all' %>"
                   data-name="<%= movie.name.toLowerCase() %>"
                   data-hall="<%= movie.hall || 'all' %>"
                   data-date="<%= movie.releaseDate ? new Date(movie.releaseDate).toISOString().split('T')[0] : '' %>">
                    <div class="movie-card card">
                        <div class="movie-card-img-wrapper">
                            <img src="<%= movie.pictureUrl || '/images/placeholder.jpg' %>" alt="<%= movie.name %>"
                                class="movie-card-img">
                            <!-- Age restriction badge overlay -->
                            <% if (movie.ageRestriction) { %>
                                <div class="age-badge"><%= movie.ageRestriction %></div>
                            <% } %>
                        </div>
                        <div class="movie-card-content">
                            <div class="movie-name">
                                <%= movie.name %>
                            </div>
                            <div class="movie-duration">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px;">
                                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                </svg>
                                <%= movie.duration %> min
                            </div>
                            <% if (movie.releaseDate) { %>
                                <div class="movie-duration">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px;">
                                        <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                                    </svg>
                                    <%= new Date(movie.releaseDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) %>
                                </div>
                            <% } %>
                            <!-- Genre tags -->
                            <% if (movie.genre) { %>
                                <div class="genre-tags">
                                    <% const genres = Array.isArray(movie.genre) ? movie.genre : [movie.genre]; %>
                                    <% genres.forEach(genre => { %>
                                        <span class="genre-tag"><%= genre %></span>
                                    <% }); %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </a>
                <% }) %>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container">
            <button id="prevPage" class="pagination-btn" disabled>
                <i class="bi bi-chevron-left"></i> Previous
            </button>
            <div id="pageNumbers" class="page-numbers"></div>
            <button id="nextPage" class="pagination-btn">
                Next <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>

    <script>
        // Movie filter, sort, and pagination functionality
        document.addEventListener('DOMContentLoaded', function() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            const movieCards = Array.from(document.querySelectorAll('.movie-card-link'));
            const searchInput = document.getElementById('movieSearch');
            const hallFilter = document.getElementById('hallFilter');
            const dateFilter = document.getElementById('dateFilter');
            const sortFilter = document.getElementById('sortFilter');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const pageNumbersDiv = document.getElementById('pageNumbers');
            
            let activeStatusFilter = 'all';
            let currentPage = 1;
            const itemsPerPage = 20; // 4 rows Ã— 5 columns

            // Status filter buttons
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    activeStatusFilter = this.getAttribute('data-filter');
                    currentPage = 1;
                    applyFiltersAndSort();
                });
            });

            // Search input
            searchInput.addEventListener('input', function() {
                currentPage = 1;
                applyFiltersAndSort();
            });

            // Hall filter
            hallFilter.addEventListener('change', function() {
                currentPage = 1;
                applyFiltersAndSort();
            });

            // Date filter
            dateFilter.addEventListener('change', function() {
                currentPage = 1;
                applyFiltersAndSort();
            });

            // Sort filter
            sortFilter.addEventListener('change', function() {
                currentPage = 1;
                applyFiltersAndSort();
            });

            // Pagination buttons
            prevPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    applyFiltersAndSort();
                }
            });

            nextPageBtn.addEventListener('click', function() {
                const filteredCards = getFilteredCards();
                const totalPages = Math.ceil(filteredCards.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    applyFiltersAndSort();
                }
            });

            function getFilteredCards() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedHall = hallFilter.value;
                const selectedDate = dateFilter.value;

                return movieCards.filter(card => {
                    const status = card.getAttribute('data-status');
                    const name = card.getAttribute('data-name');
                    const hall = card.getAttribute('data-hall');
                    const date = card.getAttribute('data-date');

                    const statusMatch = activeStatusFilter === 'all' || status === activeStatusFilter;
                    const searchMatch = !searchTerm || name.includes(searchTerm);
                    const hallMatch = selectedHall === 'all' || hall === selectedHall;
                    const dateMatch = !selectedDate || date === selectedDate;

                    return statusMatch && searchMatch && hallMatch && dateMatch;
                });
            }

            function sortCards(cards) {
                const sortValue = sortFilter.value;
                const sortedCards = [...cards];

                switch(sortValue) {
                    case 'newest':
                        sortedCards.sort((a, b) => {
                            const dateA = new Date(a.getAttribute('data-date') || '1970-01-01');
                            const dateB = new Date(b.getAttribute('data-date') || '1970-01-01');
                            return dateB - dateA;
                        });
                        break;
                    case 'oldest':
                        sortedCards.sort((a, b) => {
                            const dateA = new Date(a.getAttribute('data-date') || '1970-01-01');
                            const dateB = new Date(b.getAttribute('data-date') || '1970-01-01');
                            return dateA - dateB;
                        });
                        break;
                    case 'nameAZ':
                        sortedCards.sort((a, b) => {
                            const nameA = a.getAttribute('data-name');
                            const nameB = b.getAttribute('data-name');
                            return nameA.localeCompare(nameB);
                        });
                        break;
                    case 'nameZA':
                        sortedCards.sort((a, b) => {
                            const nameA = a.getAttribute('data-name');
                            const nameB = b.getAttribute('data-name');
                            return nameB.localeCompare(nameA);
                        });
                        break;
                }

                return sortedCards;
            }

            function updatePagination(totalItems) {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                
                // Update button states
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

                // Generate page numbers
                pageNumbersDiv.innerHTML = '';
                if (totalPages > 0) {
                    const pageInfo = document.createElement('span');
                    pageInfo.className = 'page-info';
                    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                    pageNumbersDiv.appendChild(pageInfo);
                }
            }

            function applyFiltersAndSort() {
                // Get filtered cards
                let filteredCards = getFilteredCards();

                // Sort cards
                filteredCards = sortCards(filteredCards);

                // Calculate pagination
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedCards = filteredCards.slice(startIndex, endIndex);

                // Hide all cards first
                movieCards.forEach(card => card.style.display = 'none');

                // Get the grid container
                const moviesGrid = document.querySelector('.movies-grid');

                // Reorder cards in the DOM based on sorted array
                paginatedCards.forEach(card => {
                    moviesGrid.appendChild(card);
                    card.style.display = 'block';
                });

                // Update pagination controls
                updatePagination(filteredCards.length);

                // Scroll to top of movie grid
                moviesGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Initial load
            applyFiltersAndSort();
        });
    </script>

    <%- include('../layouts/footer') %>